# TOC DevOps/SRE 最佳实践

## 关于最佳实践

这里是TOC在不同项目的维护过程中总结的关于DevOps/SRE方面的最佳实践，TOC将致力于在项目上最大限度的推行这些最佳实践。我们希望这些最佳实践能对项目的稳定运营提供帮助，也希望刚入行的新人能通过学习这些最佳实践来提升自己在DevOps/SRE方面的水平。

因为我们希望在项目上推行行业领先的流行理念和技术，所以这里整理的最佳实践也多基于此。虽然也会覆盖到一些传统的技术，但是我们建议尽早摒弃传统的维护思维和方式，避免落于人后。

最后，所谓“最佳实践”应该是**最适合自己**的实践，而**不一定是最先进**的，所以这里总结的最佳实践请适度使用，不要为了“最佳”而实践。

## 主题
- 文化和理念
- 用户与权限
- 敏感数据
- 云平台与网络
- 操作系统和服务
- 应用部署
- 脚本和工具
- 监控与可视化
- 数据与备份
- 故障与应急响应



## 文化和理念
#### 计划失败

#### 在失败中成长

## 用户与权限
#### 给每个用户建立独立的账号

  在任何的系统中，我们都强烈建议给每个用户(包括服务)建立独立的账号，而非使用共享账号。虽然这样会带来一些管理上的成本，但是独立用户账号所属和权责明确，更容易实施最小化权限管理，用户也可以有自己特性化的设定，独立的密码。另外，独立账号的使用也会大大减小账号泄露的风险。即使不慎发生账号泄漏，隔离泄漏账号所带来的影响范围更小，评估风险和操作审计等后续工作也会比较容易。 

#### 建立服务专用的账号

  一些自动化工具会需要和相关的系统/平台进行交互操作，大部分的系统/平台都会对类似的操作鉴权，因此这些工具也需要对应账号来完成相应的验证。我们建议给类似的需求建立服务专用的账号，为方便管理，可以给账号名称上加上一些表意的前后缀，比如`_svc`或者`machine_user`等来区分账号的属性。

#### 最小化权限原则

  最小化权限原则是指系统的每个程序或者用户都应该使用完成工作所需的最小权限工作。最小权限原则限制操作所需的权限，降低账号或者系统在被恶意利用时造成的损失。因此在给账号或者角色赋权时，尽可能的只赋予操作所需的权限，而非随意的扩大权限范围。即使我们需要给一些临时的操作赋权，也不要给予不必要的额外权限，并在操作完成之后清理临时权限。如有可能，我们也建议新建临时账号来完成此类操作，而非扩大原有账号的权限。

#### 使用强密码策略

  我们强烈建议使用强密码策略，一个安全的密码应该不少于12个字符，至少有三种不同的字符，如数字，标点，大小写字母。避免在密码中包含个人信息，如出生日期或名字，宠物或乐队。还要避免歌词，伴侣和常用词组等。并且我们建议不要使用重复密码，尽可能的在不同的系统中使用不同的密码，并定期更换密码。

#### 使用多重验证(MFA)

  如果对应的系统支持多重验证，我们也建议开启使用。并且建议不要把密码管理工具和MFA工具放在同一设备上。

#### 使用角色而非用户账号

  一些平台，比如AWS，支持角色使用临时认证进行获取操作权限([参考1](https://docs.aws.amazon.com/zh_cn/general/latest/gr/aws-access-keys-best-practices.html#use-roles))，所以我们建议在你的业务或者操作支持的情况下，使用角色而非用户账号来完成对应的操作。

#### 开启审计日志

  如果你的系统支持记录审计日志，我们建议请开启审计日志并保存至少半年的记录。审计日志本身是安全合规性检查的必备材料之一。审计日志也可以帮助我们进行疑难问题的定位，而定期的检查和分析也可以进一步发现可能存在的安全隐患。

#### 减少使用特权(root)账号

  在任何系统的日常管理工作中，在非必要的情况下，我们强烈建议不要使用特权(root)账号来做操作。特权账号具有系统所有权限，疏忽和不慎的操作有可能带来极大的损失。如果是在多人管理的情况下，也会增加账号泄漏的风险。我们强烈建议对于特权账号施行一切必要的安全管理，比如强密码，开启多重验证，及时的操作审计等。

## 敏感数据
#### 不在代码库中明文保存敏感信息和数据

  在代码库中不要明文保存任何的敏感信息和数据，比如数据库的密码，API验证使用的Token等。如果条件限制无法通过使用专用密码管理来获取密码，可以考虑在代码库保存加密过的数据，请[使用公开/流行的加密方式和工具]()来加密对应的数据。如果敏感信息和数据不慎被提交到远端的代码库，如果代码库为公开模式，立即设置代码库为私有模式，及时[清理历史提交记录](https://docs.github.com/en/github/authenticating-to-github/removing-sensitive-data-from-a-repository)。

#### 加密存储和传输数据

  主流的云服务厂商提供了存储加密功能，比如AWS的RDS，S3，EBS等都支持服务器端加密。我们建议开启加密功能，如成本允许或有更高级别的安全需求，可以使用自持有的密钥来加密。这样可以最大限度的减小存储介质丢失的情况下数据被泄漏的风险。如果服务提供商不能提供服务端加密，可以采用客户端加密的方式，即在本地[使用公开/流行的加密方式和工具]()加密需要保护的数据，然后保存在远端。另外，在传输的过程中，使用安全套接字层/传输层安全性 (SSL/TLS) 保护传输中的数据。

#### 使用密码工具保存用户名和密码

#### 使用公开/流行的加密方式和工具

## 云平台与网络

#### 基于账号的环境隔离
#### 分层网络设计
#### 使用ACL和网络防火墙

#### 只开放必要的端口

## 操作系统和服务

#### 不要直接暴漏资源的地址给使用者

#### 只启动必要的服务

## 应用部署

#### 使用容器或虚拟机

#### 使用牲口模式来设计业务

#### 使业务向后兼容

#### 使用弹性伸缩

#### 使用环境变量来传递参数
#### 使用唯一性Tag来标识镜像
#### 定期的检查和升级依赖包

## 脚本和工具

#### 管理脚本和业务脚本分离
#### 使用auto/Action模式编写管理脚本

## 监控与可视化

#### 使用存活检查和健康检查

## 数据与备份

#### 定期备份数据
#### 定期检查备份
#### 使用适当的存储类型保存备份

## 故障与应急响应

#### 建立应急响应流程

#### 非责备式事故分析
