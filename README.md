# TOC DevOps/SRE 最佳实践

## 关于最佳实践

这里是TOC在不同项目的维护过程中总结的关于DevOps/SRE方面的最佳实践，我们将致力于在项目上尽最大的努力来推行这些最佳实践。我们希望这些最佳实践能对项目的稳定运营提供帮助，也希望刚入行的新人能通过学习这些最佳实践来提升自己在DevOps/SRE方面的水平。

因为我们希望在项目上推行行业领先的流行理念和技术，所以这里整理的最佳实践也多基于此。虽然也会覆盖到一些传统的技术，但是我们建议尽早摒弃传统的维护思维和方式，避免落于人后。

最后，所谓“最佳实践”应该是**最适合自己**的实践，而**不一定是最先进**的，所以这里总结的最佳实践请适度取用，不要为了“最佳”而实践。

## 主题
- 用户与权限
- 敏感数据
- 云平台与网络
- 操作系统和服务
- 应用部署
- 脚本和工具
- 监控与可视化
- 数据与备份
- 故障与应急响应



## 用户与权限
#### 给每个用户建立独立的账号

  在任何的系统中，我们都强烈建议给每个用户(包括服务)建立独立的账号，而非使用共享账号。虽然这样会带来一些管理上的成本，但是独立用户账号所属和权责明确，更容易实施最小化权限管理，用户也可以有自己特性化的设定，独立的密码。另外，独立账号的使用也会大大减小账号泄露的风险。即使不慎发生账号泄漏，隔离泄漏账号所带来的影响范围更小，评估风险和操作审计等后续工作也会比较容易。 

#### 建立服务专用的账号

  一些自动化工具会需要和相关的系统/平台进行交互操作，大部分的系统/平台都会对类似的操作鉴权，因此这些工具也需要对应账号来完成相应的验证。我们建议给类似的需求建立服务专用的账号，为方便管理，可以给账号名称上加上一些表意的前后缀，比如`_svc`或者`machine_user`等来区分账号的属性。

  如果需要使用的第三方服务并不需要每个团队成员都注册账号，我们建议在注册时，使用一个管理专用而非个人所属邮箱等信息来注册，以避免团队成员变动带来的账号无法保留等影响。

#### 最小化权限原则

  最小化权限原则是指系统的每个程序或者用户都应该使用完成工作所需的最小权限工作。最小权限原则限制操作所需的权限，降低账号或者系统在被恶意利用时造成的损失。因此在给账号或者角色赋权时，尽可能的只赋予操作所需的权限，而非随意的扩大权限范围。即使我们需要给一些临时的操作赋权，也不要给予不必要的额外权限，并在操作完成之后清理临时权限。如有可能，我们也建议新建临时账号来完成此类操作，而非扩大原有账号的权限。

#### 使用强密码策略

  我们强烈建议使用强密码策略，一个安全的密码应该不少于12个字符，至少有三种不同的字符，如数字，标点，大小写字母。应避免在密码中包含个人信息，如出生日期或名字，宠物或乐队。还要避免歌词，伴侣和常用词组等。并且我们建议不要使用重复密码，尽可能的在不同的系统中使用不同的密码，并定期更换密码。

#### 使用多重验证(MFA)

  如果对应的系统支持多重验证，我们建议开启使用多重验证功能。不要把密码管理工具和MFA工具安装在在同一设备上。

#### 使用角色而非用户账号

  一些平台，比如AWS，支持角色使用临时认证进行获取操作权限([参考1](https://docs.aws.amazon.com/zh_cn/general/latest/gr/aws-access-keys-best-practices.html#use-roles))，所以我们建议在你的业务或者操作支持的情况下，使用角色而非用户账号来完成对应的操作。

#### 开启审计日志

  如果你的系统支持记录审计日志，我们建议请开启审计日志并保存至少半年的记录。审计日志本身是安全合规性检查的必备材料之一。审计日志也可以帮助我们进行疑难问题的定位，而定期的检查和分析也可以进一步发现可能存在的安全隐患。

#### 减少使用特权(root)账号

  在任何系统的日常管理工作中，在非必要的情况下，我们强烈建议不要使用特权(root)账号来做操作。特权账号具有系统所有权限，疏忽和不慎的操作有可能带来极大的损失。如果是在多人管理的情况下，也会增加账号泄漏的风险。我们强烈建议对于特权账号施行一切必要的安全管理，比如强密码，开启多重验证，及时的操作审计等。

## 敏感数据
#### 不在代码库中明文保存敏感信息和数据

  在代码库中不要明文保存任何的敏感信息和数据，比如数据库的密码，API验证使用的Token等。如果条件限制无法通过使用专用密码管理来获取密码，可以考虑在代码库保存加密过的数据，请[使用公开可靠的加密算法和工具](#使用公开可靠的加密算法和工具)来加密对应的数据。如果敏感信息和数据不慎被提交到远端的代码库，如果代码库为公开模式，立即设置代码库为私有模式，及时[清理历史提交记录](https://docs.github.com/en/github/authenticating-to-github/removing-sensitive-data-from-a-repository)。

#### 加密存储和传输数据

  主流的云服务厂商提供了存储加密功能，比如AWS的RDS，S3，EBS等都支持服务器端加密。我们建议开启加密功能，如成本允许或有更高级别的安全需求，可以使用自持有的密钥来加密。这样可以最大限度的减小存储介质丢失的情况下数据被泄漏的风险。如果服务提供商不能提供服务端加密，可以采用客户端加密的方式，即在本地[使用公开可靠的加密算法和工具](#使用公开可靠的加密算法和工具)加密需要保护的数据，然后保存在远端。在传输数据的过程中，我们建议使用加密的方式来传输，比如使用安全套接字层/传输层安全协定 (SSL/TLS) 保护传输中的数据。如果是工作交流中需要发送敏感的信息，我们推荐交换GPG公钥加密需要传输内容，而不是通过聊天软件或者邮件直接明文发送这些信息。

#### 使用密码管理工具管理账号和密码

  无论是何种类型的账号和密码，我们都建议使用密码管理工具来进行管理，都应极力避免使用文本文件或电子表格来保存。一些需要共享的账号，比如服务专用账号，特权管理账号等也通过密码管理工具来进行信息共享，并根据需要分级别控制读取和管理权限。如果管理工具支持，可以开启存储加密，定期密码更新等策略。

#### 使用公开可靠的加密算法和工具

  在加密数据的过程中，[不要使用保密的密码算法](https://www.ituring.com.cn/book/miniarticle/129179)，这是非常不安全的行为，我们强烈建议使用公开可靠的加密算法和工具，并且在当前的算法不可靠的时候，及时的更新加密的算法和工具。

## 云平台与网络

#### 基于账号的环境隔离

  在使用云平台的时候，我们强烈建议给每一个产品的每一个环境都使用独立的账号，以达到最大程度的隔离。诚然这样会带来一些成本，但是相对于带来的好处，比如说通过赋予不同账号的权限来控制资源的操作权限；降低对生产环境相关资源误操作的风险；避免某一个账号的验证信息泄漏导致所有资源面临风险；需要清理某一个下线的产品所占用的所有资源等；是非常值得的。有一些云服务提供商比如AWS可以把所拥有的一个账号升级为Orgnization账号，通过它对组织所有的子账号进行分组，账单关联和基于账号级别的策略设置等，也有助于我们更好的管理拥有的账号。

#### 分层网络设计

  我们建议在初建一个VPC网络时，至少包含以下四种类型的子网。1. 公网网络(Public Subnet)，这个子网的资源在配有一个公网的IP时，可被外部网络直接访问到。一般我们会把负载均衡，防火墙等需要直接对外暴漏的资源放置在这个子网内，这个子网内的资源一般不不会限制访问来源。2. 地址转换网络(NAT Subnet)，这个子网的资源通过地址转换之后可以访问外部网络，但是不能被外部网络直接访问，即使资源配有一个公网IP。我们一般把需要访问外部的业务和应用部署在这个网络内，但是这些业务在被外部网络访问的时候，需要通过负载均衡或者防火墙转发流量。3. 私网网络(Private Subnet)，这个子网的资源不可以被外部网络访问，同时也不可以访问外部网络。一般我们会把数据库等比较重要的资源和服务放在这里网络里面。4. 服务网络(Service Subnet)，这个子网和公网网络一样，可以直接被外网访问，我们一般在这个网络里面部署VPN，堡垒机等内部通讯使用的资源和服务，子网内的资源会被严格限制只允许特定的来源才能访问。除此之外，你可以根据自己的情况增加其他类型的子网。

#### 只开放必要的端口

  我们建议在使用访问控制列表(ACL)和安全组(Security Group)的时候，只开放必要的端口给需要访问的网络，避免使用宽泛的访问策略，防止一些服务的端口意外暴露在外部网络中，最大限度的保障网络和业务的安全。

## 操作系统和服务

#### 不要直接暴漏资源的地址给使用者

  由服务商提供的资源地址，不论是域名还是IP，都不要直接暴露给使用者。我们建议用另外一个可被管理的域名，使用CNAME（如果你的域名提供商和资源地址支持Alias则更好）的方式映射到原资源，把我们管理的域名提供给使用者来使用。这样带来的好处是如果我们需要对资源本身做更改的话，不需要使用者也做信息上的更新。有一些服务商提供的资源名称带有证书，映射后的域名会碰到证书不匹配的问题，这种情况下可以使用一个支持证书的负载均衡设备来代理对应的服务，使用者和负载均衡设备之间使用我们管理的域名证书通讯，负载均衡设备和后端的资源之间使用资源的证书通讯。

#### 只安装必要的依赖和工具

  在业务运行的系统中，无论是虚拟机还是容器中，只安装必要的依赖和工具，这样不但可以保证较小的系统大小，也能最大化避免因为工具和服务的漏洞造成被攻克的风险。如果你需要对一个有问题的业务进行排错，在隔离相应的虚拟机或者容器后安装需要的工具。在盘排错结束之后，及时[销毁这台虚拟机或者容器](#使用牲口模式来设计业务)。

#### 只运行必要的服务和端口

  对应的，在系统中只运行必要的服务，不要运行不相关的服务并开放对外访问权限。如果服务本身的业务端口和管理端口分离，根据需要限制两种端口的访问权限。

#### 加强SSH服务安全

  我们建议在你的堡垒机等需要提供SSH服务并对外部网络开放的设备上，使用非标准的端口来提供SSH服务，以减少暴力破解的风险。关闭root账号登陆，尽量使用密钥验证来登陆服务器。尽量避免使用SSH Agent，如有可能，关闭Agent转发功能。如果你不需要在机器使用隧道转发，关闭X11转发和TCP转发。如果对于安全有进一步的要求，开启MFA登陆验证。

## 应用部署

#### 使用容器或虚拟机

#### 使用牲口模式来设计业务

#### 使业务向后兼容

#### 使用弹性伸缩

#### 使用环境变量来传递参数
#### 使用唯一性Tag来标识镜像
#### 定期的检查和升级依赖包

## 脚本和工具

#### 管理脚本和业务脚本分离
#### 使用auto/Action模式编写管理脚本

## 监控与可视化

#### 使用存活检查和健康检查

#### 提供版本和主机信息接口

## 数据与备份

#### 不要在数据库中存储二进制内容

#### 定期备份数据

#### 定期检查备份
#### 使用适当的存储类型保存备份

## 故障与应急响应

#### 建立应急响应流程

#### 非责备式事故分析
